






<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2024-10-17 02:23:08 -0400">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="">
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/lesson.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/syntax.css" />
    
    <link rel="license" href="#license-info" />

    



    <!-- Favicons for everyone -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="../assets/favicons/swc/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/favicons/swc/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/favicons/swc/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/favicons/swc/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="../assets/favicons/swc/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="../assets/favicons/swc/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="../assets/favicons/swc/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../assets/favicons/swc/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-128.png" sizes="128x128" />
    <meta name="application-name" content="Software Carpentry - Single Cell RNAseq"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="../assets/favicons/swc/mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="../assets/favicons/swc/mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="../assets/favicons/swc/mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="../assets/favicons/swc/mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="../assets/favicons/swc/mstile-310x310.png" />


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->

  <title>
  Biology Driven Analyses of scRNA-Seq &ndash; Single Cell RNAseq
  </title>  

  </head>
  <body>

    








    <div class="container">
      
















  
  










<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      
      <a href="https://software-carpentry.org" class="pull-left">
        <img class="navbar-logo" src="../assets/img/swc-icon-blue.svg" alt="Software Carpentry logo" />
      </a>
      

      
      <a class="navbar-brand" href="../index.html">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

	
        <li><a href="../CODE_OF_CONDUCT.html">Code of Conduct</a></li>

        
	
        <li><a href="../setup.html">Setup</a></li>

        
        
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            
            <li><a href="../01-introduction/index.html">Introduction to Single Cell RNA-seq</a></li>
            
            
            <li><a href="../02-Experimental-Considerations/index.html">Experimental Considerations</a></li>
            
            
            <li><a href="../03-Overview-scRNA-seq-Data/index.html">Overview of scRNA-seq Data</a></li>
            
            
            <li><a href="../04-Quality-Control/index.html">Quality Control of scRNA-Seq Data</a></li>
            
            
            <li><a href="../05-Common-Analyses/index.html">Common Analyses</a></li>
            
            
            <li><a href="../06-Biology-Driven-Analyses/index.html">Biology Driven Analyses of scRNA-Seq</a></li>
            
            
            <li><a href="../07-Analyzing-Your-Data/index.html">Analyzing Your Data</a></li>
            
            
            <li><a href="../08-Future-Directions/index.html">Future Directions</a></li>
            
	    <li role="separator" class="divider"></li>
            <li><a href="../aio/index.html">All in one page (Beta)</a></li>
          </ul>
        </li>
        
	

	
	
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Extras <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../reference.html">Reference</a></li>
            
            
            
              <li><a href="../about/index.html">About</a></li>
            
            
            
            
              <li><a href="../discuss/index.html">Discussion</a></li>
            
            
            
            
              <li><a href="../figures/index.html">Figures</a></li>
            
            
            
            
              <li><a href="../guide/index.html">Instructor Notes</a></li>
            
            
          </ul>
        </li>
	

	
        <li><a href="../LICENSE.html">License</a></li>
	
	
	<li><a href="/edit//_episodes_rmd/06-Biology-Driven-Analyses.Rmd" data-checker-ignore>Improve this page <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a></li>
	
	
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>



















  
  











<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../05-Common-Analyses/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
    <h3 class="maintitle"><a href="../">Single Cell RNAseq</a></h3>
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../07-Analyzing-Your-Data/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>

<article>
<div class="row">
  <div class="col-md-1">
  </div>
  <div class="col-md-10">
    <h1 class="maintitle">Biology Driven Analyses of scRNA-Seq</h1>
  </div>
  <div class="col-md-1">
  </div>
</div>












<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 120 min
      <br/>
      <strong>Exercises:</strong> 10 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>What are some scRNA-Seq analyses that might provide me with biological insight?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Gain an understanding of some of the important caveats for identifying major cell types in scRNA-Seq.</p>
</li>
	
	<li><p>Understand the ability (and limitations) of scRNA-Seq data for quantifying differences in gene expression.</p>
</li>
	
	<li><p>Have basic ability to be able to conduct enrichment analyses of gene expression in scRNA-Seq.</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">suppressPackageStartupMessages</span><span class="p">(</span><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">))</span><span class="w">
</span><span class="n">suppressPackageStartupMessages</span><span class="p">(</span><span class="n">library</span><span class="p">(</span><span class="n">Seurat</span><span class="p">))</span><span class="w">
</span><span class="n">suppressPackageStartupMessages</span><span class="p">(</span><span class="n">library</span><span class="p">(</span><span class="n">harmony</span><span class="p">))</span><span class="w">
</span><span class="n">suppressPackageStartupMessages</span><span class="p">(</span><span class="n">library</span><span class="p">(</span><span class="n">DESeq2</span><span class="p">))</span><span class="w">
</span><span class="n">suppressPackageStartupMessages</span><span class="p">(</span><span class="n">library</span><span class="p">(</span><span class="n">enrichR</span><span class="p">))</span><span class="w">

</span><span class="n">data_dir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'data'</span><span class="w">
</span></code></pre></div></div>

<p>If you want, install the <code class="language-plaintext highlighter-rouge">presto</code> package to speed up looking for 
marker genes:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">install.packages</span><span class="p">(</span><span class="s1">'remotes'</span><span class="p">)</span><span class="w">
</span><span class="n">remotes</span><span class="o">::</span><span class="n">install_github</span><span class="p">(</span><span class="s2">"immunogenomics/presto"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># set a seed for reproducibility in case any randomness used below</span><span class="w">
</span><span class="n">set.seed</span><span class="p">(</span><span class="m">1418</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="read-data-from-previous-lesson">Read Data from Previous Lesson</h2>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">liver</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">readRDS</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span><span class="w"> </span><span class="s1">'lesson05.rds'</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<h2 id="batch-correction">Batch correction</h2>

<p><img src="../fig/single_cell_flowchart_10.png" width="800px" alt="Single Cell Flowchart" /></p>

<p>In bulk RNA-Seq experiments, it is usually vital that we apply a
correction for samples profiled in different batches. In single cell
RNA-Seq experiments the situation is a bit more nuanced. We certainly
want to take into consideration if our samples have been profiled in
different batches, but the point at which we do so can vary.</p>

<p>Consider this example. 
Distinguishing between cell types is a robust process, in fact
we can do a fairly good job distinguishing major cell types
with just a few dozen genes.
We might expect that batch effects are small enough that they would
not strongly impede our ability to identify cell types.
We could do clustering and cell type identification, then when
we are doing differential expression testing we could include a covariate
for batch.
This is an example where we would be appropriately considering batch,
but not at <em>every</em> step in the analysis.</p>

<p>In contrast, in these liver data, we are going to show an 
example of why batch correction earlier in the analytical
process can be helpful.
The reason this section is included in the lesson on
“biology-driven” analyses is that we will bring in some understanding
of biology to show a specific example of cells that were separated
(in UMAP space and in different clusters)
by an unknown batch-related factor when they should have been 
clustering together as the same cell type.</p>

<p>We don’t know much about when these liver samples were profiled
and what differences in the mice, equipment, or operators there 
could have been. 
There are 9 mice that were profiled
in the data we are looking at.
Let’s start by looking at whether specific cell clusters in our 
clustering + UMAP are derived largely from one or a few samples.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">table</span><span class="p">(</span><span class="n">liver</span><span class="o">$</span><span class="n">sample</span><span class="p">,</span><span class="w"> </span><span class="n">liver</span><span class="o">$</span><span class="n">seurat_clusters</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       
           0    1    2    3    4    5    6    7    8    9   10   11   12   13
  CS144   66   10    1   20    4  736    2 1747   77    8  990  135   35    0
  CS48     3    0   10    0   49    0 2028    2    0    0    0    7    0    0
  CS52     1    0    1    0 3815    0  941    0    1    5    0   46   86   24
  CS53     0    0    1 4284    4   21    8    0  650 1159    1    0    8  632
  CS88  3840  235 1154    0    8    4    1    1    5    0    0  206    4    0
  CS89   148  119  381    2    0  691    0    0  200    0    1   13  155    0
  CS92  3601  115  981    1    9    4    5    0    1    0    0  181    4    0
  CS96   299 4342 1965    0    0    3    1    0    4    0    0  312    3    0
  CS97    95  287  310   10    0 2321    1    0  575    1    3   20  434    0
       
          14   15   16   17   18   19   20   21   22
  CS144  274   74   51    0   33   87   31  162   12
  CS48     0    0    5    0    0   10    0    0    0
  CS52     0    0   35    0    0   71    0    1    8
  CS53     2    2    0  402  161    0   51    1    0
  CS88     0    0  123    0    0   39    2    0   24
  CS89   126  143    6    0   57    4   75   57    3
  CS92     0    0  105    0    0   36    1    0   17
  CS96     0    0  198    0    1   73    2    0   37
  CS97   246  330    9    0  141    7  153   90    1
</code></pre></div></div>

<p>Notice cluster 13. Most of the cells are derived from mouse CS53.
Let’s look into this a little further.
First we plot the cells in UMAP space colored by mouse of origin,
demonstrating some fairly clear batch effects – indicated by</p>

<ul>
  <li>cell clusters that contain dots of only one or a few colors</li>
  <li>clusters of different colors that are near each other but not overlapping</li>
</ul>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UMAPPlot</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="n">group.by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'sample'</span><span class="p">,</span><span class="w"> </span><span class="n">pt.size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-sample_effects-1.png" alt="plot of chunk sample_effects" width="504" />
<p class="caption">plot of chunk sample_effects</p>
</div>

<p>Let’s see which genes are expressed in cluster 13.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">markers13</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">FindMarkers</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="s1">'13'</span><span class="p">,</span><span class="w"> </span><span class="n">only.pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">logfc.threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w">
                         </span><span class="n">max.cells.per.ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">)</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">markers13</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>              p_val avg_log2FC pct.1 pct.2     p_val_adj
Cd79a 1.522138e-182   7.370387 0.998 0.011 3.062541e-178
Ighm  9.697775e-180   5.805552 0.998 0.088 1.951192e-175
Cd79b 4.198563e-177   6.551524 0.989 0.060 8.447508e-173
Ebf1  2.315879e-175   7.085958 0.968 0.010 4.659549e-171
Igkc  1.606549e-172   7.293541 0.974 0.058 3.232376e-168
Iglc2 3.423234e-164   6.956922 0.939 0.015 6.887546e-160
</code></pre></div></div>

<p>We’ll talk in detail about the information in this type of table later.
For now, just be aware that these are genes that are expressed much more
highly in cluster 13 than in the other cells.</p>

<p>Look at the genes we are finding. These genes are expressed in almost
all cells of cluster 13 (column <code class="language-plaintext highlighter-rouge">pct.1</code>) and in few of the cells in other
clusters (column <code class="language-plaintext highlighter-rouge">pct.2</code>). 
An immunologist would likely recognize these as B cell genes. The gene 
Cd79a is very frequently captured well in single cell transcriptomics and
is highly specific to B cells. Let’s look at where Cd79a is expressed.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">VlnPlot</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="s1">'Cd79a'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-cd79a_vln-1.png" alt="plot of chunk cd79a_vln" width="504" />
<p class="caption">plot of chunk cd79a_vln</p>
</div>

<p>Expression of this gene is very clearly <strong>ON</strong> in clusters 13 and 21, 
and <strong>OFF</strong> in all other clusters. Let’s look at where clusters 13 and 21
are:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FeaturePlot</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="s2">"Cd79a"</span><span class="p">,</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'lightgrey'</span><span class="p">,</span><span class="w"> </span><span class="s1">'red'</span><span class="p">),</span><span class="w"> 
            </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">label.size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-cd79a_fp-1.png" alt="plot of chunk cd79a_fp" width="504" />
<p class="caption">plot of chunk cd79a_fp</p>
</div>

<p>Interesting. Clusters 13 and 21 are near each other. Recall that
we saw that cluster 13 cells are largely derived from a single mouse.
Looking at cluster 21:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">table</span><span class="p">(</span><span class="n">liver</span><span class="o">$</span><span class="n">sample</span><span class="p">[</span><span class="n">liver</span><span class="o">$</span><span class="n">seurat_clusters</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'21'</span><span class="p">])</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
CS144  CS52  CS53  CS89  CS97 
  162     1     1    57    90 
</code></pre></div></div>

<p>we can see that this cluster contains cells from several mice. 
Both clusters 13 and 21 are B cells – you can verify this on your own by 
looking at expression of other B cell marker genes. 
It is unlikely that there would be heterogeneous types of B cells that
segregate almost perfectly between different batches. Rather, it seems that
there is some batch-driven pattern in gene expression that is causing
these cells to cluster separately when they should cluster 
together.</p>

<p>In the liver cell atlas paper 
<a href="https://www.cell.com/cell/fulltext/S0092-8674(21)01481-1">Guilliams et al</a>
from which we obtained these data, the authors applied a batch
correction across samples. They used a method called harmony. 
We will run harmony on the subset of data that we are working with. 
We expect that a successful batch correction algorithm will bring the cells
in clusters 13 and 21 together into a single cluster.</p>

<p>Harmony is an algorithm that projects cells into a shared low-dimensional embedding.
In an iterative process, harmony learns cell-specific linear adjustment
factors in order to integrate datasets in a way that favors clusters 
containing cells from multiple datasets. At the same time, the method has
features that allow it to maintain separation of cell clusters that are
unique to particular datasets. 
The harmony method is described in 
<a href="https://www.nature.com/articles/s41592-019-0619-0">Korsunsky et al. 2019</a>
and has a website at <a href="https://portals.broadinstitute.org/harmony/">this link</a>.
The following animation, available from 
<a href="https://slowkow.com/notes/harmony-animation/">this link</a>
in a beautiful and comprehensive workup by 
<a href="https://slowkow.com/">Kamil Slowikowski</a>, shows in a visual manner
how cells from different donors are integrated together</p>

<!-- <img src="../fig/harmony-in-motion-3donors.gif" alt="Animation demonstrating harmony iterative integration" width="500px"> -->
<p><img src="../fig/harmony-in-motion-3donors.gif" alt="Animation demonstrating harmony iterative integration" /></p>

<p>Let’s run harmony on the liver data. Harmony itself returns a
low-dimensional embedding of the cells, much like the reduced dimensional
embedding of cells that we previously produced in PC-space.
Recall that we performed clustering and projection to two dimensions with 
UMAP all using the PCA dimension reduction. We will now redo those 
steps but use the <em>harmony</em> reduction instead.
Note that harmony has several parameters that could be tweaked. The most
important may be theta. Higher values of theta force more mixing across 
batches. We will use the same values of each parameter that the authors
of the liver cell atlas used – their code is available at 
<a href="https://github.com/guilliottslab/scripts_GuilliamsEtAll_Cell2022/blob/main/3b_Harmony.R">this link</a>.</p>

<p>After we run harmony using the same parameters the authors used, we will
look at the harmony components and decide how many to use – in a way
analogous to deciding how many PCs to use for UMAP and clustering.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Store old UMAP and old clusters</span><span class="w">
</span><span class="n">liver</span><span class="o">$</span><span class="n">before_harmony_clusters</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">liver</span><span class="o">$</span><span class="n">seurat_clusters</span><span class="w">
</span><span class="n">liver</span><span class="o">@</span><span class="n">misc</span><span class="o">$</span><span class="n">noharmony_umap</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">liver</span><span class="o">@</span><span class="n">reductions</span><span class="o">$</span><span class="n">umap</span><span class="w">

</span><span class="c1"># Run harmony</span><span class="w">
</span><span class="n">liver</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">RunHarmony</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="s1">'sample'</span><span class="p">,</span><span class="w"> </span><span class="n">assay.use</span><span class="o">=</span><span class="s1">'RNA'</span><span class="p">,</span><span class="w">
           </span><span class="n">theta</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">dims.use</span><span class="o">=</span><span class="m">1</span><span class="o">:</span><span class="m">40</span><span class="p">,</span><span class="w"> </span><span class="n">max.iter.harmony</span><span class="o">=</span><span class="m">100</span><span class="p">)</span><span class="w">
</span><span class="n">ElbowPlot</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="n">reduction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'harmony'</span><span class="p">,</span><span class="w"> </span><span class="n">ndims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">40</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-harmony-1.png" alt="plot of chunk harmony" width="612" />
<p class="caption">plot of chunk harmony</p>
</div>

<p>Let’s again pick 24 dimensions, just like we looked at 24 dimensions
in PC space.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">liver</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">FindNeighbors</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="n">reduction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'harmony'</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">24</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
         </span><span class="n">FindClusters</span><span class="p">(</span><span class="n">verbose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
         </span><span class="n">RunUMAP</span><span class="p">(</span><span class="n">dims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">24</span><span class="p">,</span><span class="w"> </span><span class="n">reduction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'harmony'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Computing nearest neighbor graph
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Computing SNN
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>02:21:02 UMAP embedding parameters a = 0.9922 b = 1.112
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>02:21:02 Read 44253 rows and found 24 numeric columns
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>02:21:02 Using Annoy for neighbor search, n_neighbors = 30
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>02:21:02 Building Annoy index with metric = cosine, n_trees = 50
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0%   10   20   30   40   50   60   70   80   90   100%
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[----|----|----|----|----|----|----|----|----|----|
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>**************************************************|
02:21:06 Writing NN index file to temp file /var/folders/42/vng3302d5jn562sj58fjzszwhbfnwc/T//Rtmp0tpUp7/filefa7af2d397e
02:21:06 Searching Annoy index using 1 thread, search_k = 3000
02:21:18 Annoy recall = 100%
02:21:19 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30
02:21:21 Initializing from normalized Laplacian + noise (using RSpectra)
02:21:29 Commencing optimization for 200 epochs, with 1888048 positive edges
02:21:53 Optimization finished
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">liver</span><span class="o">$</span><span class="n">after_harmony_clusters</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">liver</span><span class="o">$</span><span class="n">seurat_clusters</span><span class="w">
</span></code></pre></div></div>

<p>Now let’s see where the cells from the former
clusters 13 and 21 appear in our new clustering.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">table</span><span class="p">(</span><span class="n">liver</span><span class="o">$</span><span class="n">before_harmony_clusters</span><span class="p">,</span><span class="w"> 
      </span><span class="n">liver</span><span class="o">$</span><span class="n">after_harmony_clusters</span><span class="p">)[</span><span class="nf">c</span><span class="p">(</span><span class="s1">'13'</span><span class="p">,</span><span class="w"> </span><span class="s1">'21'</span><span class="p">),</span><span class="w"> </span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    
       0   1   2   3   4   5   6   7   8   9  10  11  12  13  14
  13   0   0   0   0   0   0   0 656   0   0   0   0   0   0   0
  21   0   1   0   1   0   0   0 309   0   0   0   0   0   0   0
</code></pre></div></div>

<p>These cells are nearly <em>all</em> in one new cluster, cluster 7. This cluster
exclusively expresses the B cell gene Cd79a, suggesting that the
harmony batch correction has accomplished the task that we had hoped.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FeaturePlot</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="s1">'Cd79a'</span><span class="p">,</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'lightgrey'</span><span class="p">,</span><span class="w"> </span><span class="s1">'red'</span><span class="p">),</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> 
            </span><span class="n">label.size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-c8-1.png" alt="plot of chunk c8" width="504" />
<p class="caption">plot of chunk c8</p>
</div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">VlnPlot</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="s1">'Cd79a'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-c9-1.png" alt="plot of chunk c9" width="576" />
<p class="caption">plot of chunk c9</p>
</div>

<p>We will work with the harmony clusters from this point forward.
In a real analysis we should spend more time trying different
parameters and verifying that our results are robust to a variety of
different choices. We might also examine other cell clusters that 
were specific to one batch in an effort to determine whether they
are like this B cell example and <em>should</em> be better aligned between 
batches, or whether the cells are truly unique to that batch and 
<em>should not</em> be aligned with cells present in other batches.</p>

<p>Next we take a step specific to this lesson that would not normally
be a part of your single cell data analysis. 
While developing
the course content we found some variability in the numbers
assigned to clusters. This may be due to minor variations in
package versions, because we do set a seed for random number 
reproducibility. In the next chunk we rename clusters to ensure
that we are all working with a common cluster numbering system.
Don’t worry about how we got this list of genes for now.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">genes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'Socs3'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Gnmt'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Timd4'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Ms4a4b'</span><span class="p">,</span><span class="w"> </span><span class="s1">'S100a4'</span><span class="p">,</span><span class="w">
           </span><span class="s1">'Adgrg6'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Cd79a'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Siglech'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Dcn'</span><span class="p">,</span><span class="w"> 
           </span><span class="s1">'Wdfy4'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Vwf'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Spp1'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Hdc'</span><span class="p">)</span><span class="w">
</span><span class="n">Idents</span><span class="p">(</span><span class="n">liver</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'after_harmony_clusters'</span><span class="w">
</span><span class="n">a</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AverageExpression</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">genes</span><span class="p">)[[</span><span class="s1">'RNA'</span><span class="p">]]</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>As of Seurat v5, we recommend using AggregateExpression to perform pseudo-bulk analysis.
First group.by variable `ident` starts with a number, appending `g` to ensure valid variable names
This message is displayed once per session.
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">highest_clu</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colnames</span><span class="p">(</span><span class="n">a</span><span class="p">)[</span><span class="n">apply</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">genes</span><span class="p">,</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">which.max</span><span class="p">)]</span><span class="w">

</span><span class="n">cluster_converter</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">setNames</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="s1">'c'</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="o">:</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="o">:</span><span class="m">7</span><span class="p">,</span><span class="w"> </span><span class="m">9</span><span class="o">:</span><span class="m">14</span><span class="p">)),</span><span class="w"> </span><span class="n">highest_clu</span><span class="p">)</span><span class="w">
</span><span class="n">remaining_clusters</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">setdiff</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="s1">'g'</span><span class="p">,</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">Idents</span><span class="p">(</span><span class="n">liver</span><span class="p">)))),</span><span class="w">
                              </span><span class="n">highest_clu</span><span class="p">)</span><span class="w">
</span><span class="n">a</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AverageExpression</span><span class="p">(</span><span class="n">subset</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> 
                              </span><span class="n">idents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"g"</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"> </span><span class="n">remaining_clusters</span><span class="p">)),</span><span class="w">
                       </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Lyve1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Cd5l"</span><span class="p">,</span><span class="w"> </span><span class="s1">'Igfbp6'</span><span class="p">))[[</span><span class="s1">'RNA'</span><span class="p">]]</span><span class="w">
</span><span class="n">highest_clu</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unname</span><span class="p">(</span><span class="n">colnames</span><span class="p">(</span><span class="n">a</span><span class="p">))[</span><span class="n">apply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">which.max</span><span class="p">)]</span><span class="w">
</span><span class="n">cluster_converter</span><span class="p">[</span><span class="n">highest_clu</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'c15'</span><span class="p">,</span><span class="w"> </span><span class="s1">'c2'</span><span class="p">,</span><span class="w"> </span><span class="s1">'c8'</span><span class="p">)</span><span class="w">

</span><span class="n">liver</span><span class="o">$</span><span class="n">renamed_clusters</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unname</span><span class="p">(</span><span class="n">cluster_converter</span><span class="p">[</span><span class="n">paste0</span><span class="p">(</span><span class="s1">'g'</span><span class="p">,</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">liver</span><span class="o">$</span><span class="n">after_harmony_clusters</span><span class="p">))])</span><span class="w">
</span><span class="n">Idents</span><span class="p">(</span><span class="n">liver</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'renamed_clusters'</span><span class="w">
</span></code></pre></div></div>

<h2 id="finding-marker-genes">Finding marker genes</h2>

<p><img src="../fig/single_cell_flowchart_11.png" width="800px" alt="Single Cell Flowchart" /></p>

<p>Now we will find marker genes for our clusters. Finding marker genes takes a
while so we will downsample our data to speed up the process.
The <code class="language-plaintext highlighter-rouge">downsample</code> argument to the <code class="language-plaintext highlighter-rouge">subset()</code> function means that Seurat
will take a random 300 (maximum) cells from each cluster in our
<code class="language-plaintext highlighter-rouge">liver_mini</code> object.
Even with the downsampled data this marker-finding will take a few minutes.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">liver_mini</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="n">downsample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">300</span><span class="p">)</span><span class="w">
</span><span class="n">markers</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">FindAllMarkers</span><span class="p">(</span><span class="n">liver_mini</span><span class="p">,</span><span class="w"> </span><span class="n">only.pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> 
                          </span><span class="n">logfc.threshold</span><span class="w">	</span><span class="o">=</span><span class="w"> </span><span class="n">log2</span><span class="p">(</span><span class="m">1.25</span><span class="p">),</span><span class="w"> </span><span class="n">min.pct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">)</span><span class="w"> 
</span></code></pre></div></div>

<p>These cluster marker genes are very useful. By definition, the 
marker genes vary in expression between the cells in our dataset.
Therefore each gene is helping to capture some aspect of the 
cellular heterogeneity found within the liver tissue we profiled.</p>

<p>The most important task we will carry out using our marker genes is
the identification of cell type labels for each cluster.
One approach to obtaining cell type labels is to use an automated
method like <code class="language-plaintext highlighter-rouge">SingleR</code>, which was introduced in 
<a href="https://doi.org/10.1038/s41590-018-0276-y">Aran et al. 2019</a>
and has a companion Bioconductor package
<a href="https://bioconductor.org/packages/release/bioc/html/SingleR.html">here</a>.
This method</p>
<blockquote>
  <p>performs unbiased cell type recognition from single-cell RNA sequencing 
data, by leveraging reference transcriptomic datasets of pure cell 
types to infer the cell of origin of each single cell independently.</p>
</blockquote>

<p>A method like <code class="language-plaintext highlighter-rouge">SingleR</code> is a great option for taking a first look at your
data and getting a sanity check for what cell types are present.
However, we find that the reference cell type data are often insufficient
to categorize the full cellular diversity in many datasets. 
An automated method might be a great way to initially identify 
T cells, macrophages, or fibroblasts – but might struggle with 
categorizing more detailed subsets like inflammatory macrophages or
activated fibroblasts.</p>

<p>The “classic” way to identify cell types in your scRNA-Seq data
is by looking at the marker genes and manually labelling each cell type.
This manual method has been used ever since the first single cell 
transcriptomic studies of tissue cellular heterogeneity. 
There are both advantages and disadvantages to the manual approach.
The advantages include:</p>

<ul>
  <li>The ability to utilize considerable subjective judgement – after all, you
 should be familiar with the tissue you are looking at and you can label
 cells with arbitrary levels of precision and descriptiveness</li>
  <li>The possibility to identify cells that are not well represented in 
 existing data/databases like that used by <code class="language-plaintext highlighter-rouge">SingleR</code></li>
</ul>

<p>Disadvantages include:</p>

<ul>
  <li>This method can be slow and tedious;</li>
  <li>Your biological knowledge of the tissue might cause you to mislabel cells.</li>
</ul>

<p>We will show an example of this type of cell type identification
below.</p>

<p>One could also integrate your data with other existing datasets
that have cell labels, and do label transfer. There is more information
on this topic in lesson 7 where you will have the opportunity to
(potentially) try out this approach on your own data.
This is a very useful approach that is likely to become 
increasingly useful as the scientific community accumulates more
and more scRNA-Seq datasets.</p>

<h2 id="identifying-cell-types">Identifying cell types</h2>

<p>Let’s plot the expression of some of the major cell type markers. Look at the 
data.frame <code class="language-plaintext highlighter-rouge">markers</code> for a summary of the markers we found above. We’ll massage 
the <code class="language-plaintext highlighter-rouge">markers</code> data.frame into a more tidy format:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">old_markers</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">markers</span><span class="w">
</span><span class="n">markers</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as_tibble</span><span class="p">(</span><span class="n">markers</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
              </span><span class="n">select</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span><span class="w"> </span><span class="n">gene</span><span class="p">,</span><span class="w"> </span><span class="n">avg_log2FC</span><span class="p">,</span><span class="w"> </span><span class="n">pct.1</span><span class="p">,</span><span class="w"> </span><span class="n">pct.2</span><span class="p">,</span><span class="w"> </span><span class="n">p_val_adj</span><span class="p">)</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">markers</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 6 × 6
  cluster gene    avg_log2FC pct.1 pct.2 p_val_adj
  &lt;fct&gt;   &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
1 c0      Flt4          2.98 0.987 0.188 2.26e-242
2 c0      Stab2         3.12 0.98  0.206 8.48e-240
3 c0      Oit3          2.95 0.987 0.197 3.98e-237
4 c0      Adam23        2.97 0.94  0.162 4.79e-232
5 c0      Fam167b       2.97 0.997 0.223 1.68e-229
6 c0      Cldn5         2.68 0.99  0.189 1.58e-225
</code></pre></div></div>

<p>In the <code class="language-plaintext highlighter-rouge">markers</code> tibble, the columns have the following meanings:</p>

<ul>
  <li>cluster – the cluster in which expression of the marker gene is enriched</li>
  <li>gene – the gene that has high expression in this cluster</li>
  <li>avg_log2FC – the log2 fold change difference in expression of the gene
 between this cluster compared to <em>all</em> the rest of the cells</li>
  <li>pct.1 – the fraction of cells in this cluster that express the gene 
 (expression is just quantified as a nonzero count for this gene)</li>
  <li>pct.2 – the fraction of cells <em>not</em> in this cluster (i.e. all other cells)
 that express the gene</li>
  <li>p_val_adj – a multiple testing corrected p-value (Bonferroni 
 corrected) for the marker indicating
 the significance of expression enrichment in this cluster compared to all
 other cells</li>
</ul>

<p>You should be aware of one weakness of finding cell types using this approach. 
As mentioned above, this marker gene-finding function compares expression
of a gene in cluster X to expression of the gene in all other cells. But 
what if a gene is highly expressed in cluster X and in some other tiny 
cluster, cluster Y? If we compare cluster X to all other cells, it will look 
like the gene is specific to cluster X, when really the gene is
specific to both clusters X and Y. One could modify the marker gene-finding
function to compare all clusters in a pairwise fashion and then unify
the results in order to get around this issue.
Dan Skelly has some code available 
<a href="https://gist.github.com/daskelly/09c1d2ae8dc3b1de1fe2ec2dbd0dd44d">here</a>
that implements such an approach in the Seurat framework, should you
wish to try it.</p>

<p>In this course, we will not get into this level of detail.</p>

<p>Let’s look at the top 3 markers for each cluster:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">group_by</span><span class="p">(</span><span class="n">markers</span><span class="p">,</span><span class="w"> </span><span class="n">cluster</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">top_n</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">avg_log2FC</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">n</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">pivot_wider</span><span class="p">(</span><span class="n">id_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">avg_log2FC</span><span class="p">,</span><span class="w"> </span><span class="n">pct.1</span><span class="p">,</span><span class="w"> </span><span class="n">pct.2</span><span class="p">,</span><span class="w"> </span><span class="n">p_val_adj</span><span class="p">),</span><span class="w"> 
              </span><span class="n">names_from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'rank'</span><span class="p">,</span><span class="w"> </span><span class="n">values_from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'gene'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 15 × 4
# Groups:   cluster [15]
   cluster `1`           `2`     `3`       
   &lt;fct&gt;   &lt;chr&gt;         &lt;chr&gt;   &lt;chr&gt;     
 1 c0      Lyve1         Plet1os AC126280.1
 2 c6      Nrg1          Gja5    Cyp1a1    
 3 c12     Wnt9b         Ajap1   Tnni3     
 4 c1      Gsta2         Gm27216 Gstm3     
 5 c13     1700011H14Rik Fermt1  Cldn6     
 6 c2      Lyve1         Id4     Flrt1     
 7 c10     Gpat2         Bmp10   Adamts13  
 8 c8      Upk3b         Msln    Chst4     
 9 c4      Gm2682        Gzma    Samd3     
10 c5      Cx3cr1        F13a1   Tnip3     
11 c7      Cd79a         Fcmr    Cr2       
12 c9      Siglech       Gm21762 Pgam2     
13 c3      Folr2         Vsig4   Fam167a   
14 c11     Xcr1          Gcsam   Sept3     
15 c14     S100a8        S100a9  Stfa2l1   
</code></pre></div></div>

<p>Recognizing these genes might be a big challenge if you are not used to looking 
at single cell gene expression. Let’s check out expression of some top genes
in each cell cluster. These genes were previously identified as the top
marker for similar clusters in a previous version of Seurat. The list of
genes is no longer identical, however all of these genes are among
the top markers:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># top_markers &lt;- group_by(markers, cluster) %&gt;% </span><span class="w">
</span><span class="c1">#                  arrange(desc(avg_log2FC)) %&gt;%</span><span class="w">
</span><span class="c1">#                  top_n(1, avg_log2FC) %&gt;% pull(gene)</span><span class="w">
</span><span class="n">top_markers</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"S100a9"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Dcn"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Spp1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Igkc"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Ccl5"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Rspo3"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Siglech"</span><span class="p">,</span><span class="w"> 
               </span><span class="s2">"Fabp1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Cst3"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Lyz2"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Ly6a"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Clec4f"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Cd5l"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Kdr"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Clec4g"</span><span class="p">)</span><span class="w">

</span><span class="n">VlnPlot</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top_markers</span><span class="p">,</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">flip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-top_markers2-1.png" alt="plot of chunk top_markers2" width="576" />
<p class="caption">plot of chunk top_markers2</p>
</div>

<p>What does this tell us? Well, there are some genes here that are quite specific 
to one cluster (e.g. S100a9, Spp1, Ccl5, Siglech), but there are a few markers 
that are not very good markers at all (e.g. Fabp1, Cst3) and some that are not 
very specific (e.g. Clec4f, Cd5l, Kdr, Clec4g).</p>

<p>Let’s look at one of these last kinds of markers – <em>Kdr</em>. Our violin plot above
shows that this gene is expressed in clusters c0, c6, c12, and c2.
If we look at a UMAP plot</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UMAPPlot</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">label.size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">NoLegend</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-expr-1.png" alt="plot of chunk expr" width="612" />
<p class="caption">plot of chunk expr</p>
</div>

<p>we see that these clusters are smaller bits of a large cloud of points
in UMAP space. This is probably a relatively heterogenous cell type or
or a continuum of cells (e.g. differentiating cells or cells being
activated by some stimulus). Nevertheless it is fairly clear that
these cells all express Kdr:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FeaturePlot</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Kdr"</span><span class="p">,</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'lightgrey'</span><span class="p">,</span><span class="w"> </span><span class="s1">'red'</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-expr2-1.png" alt="plot of chunk expr2" width="612" />
<p class="caption">plot of chunk expr2</p>
</div>

<p>If we do some digging, we see that Kdr encodes
<a href="https://www.uniprot.org/uniprotkb/P35968">vascular endothelial growth factor receptor 2</a>.
In the liver, we would expect endothelial cells to be fairly 
abundant. Therefore we can already say with relatively high
confidence that clusters c0, c2, c6, and c12 are endothelial cells.</p>

<p>Looking again at the violin plot above, there are some genes that
are often seen in scRNA-Seq data and are excellent markers:</p>

<ul>
  <li><em>S100a9</em> is a marker for neutrophils (or the broader category of granulocytes) - c14</li>
  <li><em>Ccl5</em> (which encodes RANTES) is a marker for T cells. The T cell cluster might also include some other related immune cell types (natural killer [NK] cells and innate lymphoid cells [ILCs]) - c4</li>
  <li><em>Siglech</em> is a marker for plasmacytoid dendritic cells - c9</li>
</ul>

<p>We have now identified (at least tentative) cell types for clusters
c0, c2, c4, c6, c9, c12, and c14.</p>

<p>Let’s turn to those markers that seemed to be expressed across
all or almost all cell types (recall Cst3 and Fabp1). 
Let’s focus on cluster c1. This is a pretty large cluster.
In our violin plot cluster c1 is marked only by Fabp1, which is much
higher in cluster c1 than in any other cluster, but still has high background
in ALL clusters.</p>

<p>Doing a bit of sleuthing, we find that Fabp1 is expressed in
hepatocytes. For example,
<a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4655993/">this reference</a> 
says that Fabp1 is found abundantly in the cytoplasm of hepatocytes.
It also makes sense that cluster c1 is hepatocytes because this cluster 
is large and we expect a lot of hepatocytes in the liver.</p>

<p>However, why do we see high background levels of Fabp1?
The reason might be due to ambient RNA. If a liver cell lyses and releases 
its contents into the “soup”, the cell’s RNA molecules could tag along
for the ride in any droplet with any other cell type.
This ambient RNA would act as noise in the transcriptome of
each cell. The problem of ambient RNA can vary considerably between
samples. A recent paper by 
<a href="https://pubmed.ncbi.nlm.nih.gov/36240767/">Caglayan et al</a> gives a nice
case study and examines the phenomenology of ambient RNA in single
nucleus RNA-Seq.
There are several methods to correct for high levels of
ambient RNA, with <a href="https://cellbender.readthedocs.io/en/latest/">CellBender</a>
showing good performance in multiple studies. 
We will not apply an ambient RNA correction for this course.</p>

<p>To examine whether these data show evidence of a hepatocyte
ambient RNA signature, we start by looking at our non-specific marker
Fabp1:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FeaturePlot</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="s2">"Fabp1"</span><span class="p">,</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'lightgrey'</span><span class="p">,</span><span class="w"> </span><span class="s1">'red'</span><span class="p">),</span><span class="w">
            </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">label.size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-expr3-1.png" alt="plot of chunk expr3" width="612" />
<p class="caption">plot of chunk expr3</p>
</div>

<p>This seems consistent with our expectations based on what we know about
ambient RNA. Let’s look at another hepatocyte marker:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FeaturePlot</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="s2">"Serpina1a"</span><span class="p">,</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'lightgrey'</span><span class="p">,</span><span class="w"> </span><span class="s1">'red'</span><span class="p">),</span><span class="w">
            </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">label.size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-expr4-1.png" alt="plot of chunk expr4" width="612" />
<p class="caption">plot of chunk expr4</p>
</div>

<p>Very similar. We tentatively conclude that this dataset has a noticeable
amount of hepatocyte ambient RNA contributing to all cell transcriptomes.
Let’s label cluster c1 as hepatocytes.</p>

<p>Because of <em>Fabp1</em> and other noisy markers in our cluster-specific
gene expression data.frame, we’ll try filtering our markers to grab only
those that are not expressed too highly (on average) in
all the other cells:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">specific_markers</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">group_by</span><span class="p">(</span><span class="n">markers</span><span class="p">,</span><span class="w"> </span><span class="n">cluster</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">avg_log2FC</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">pct.2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.2</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">top_n</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">avg_log2FC</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">pull</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span><span class="w">
</span><span class="n">VlnPlot</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">specific_markers</span><span class="p">,</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">flip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-sp_markers-1.png" alt="plot of chunk sp_markers" width="576" />
<p class="caption">plot of chunk sp_markers</p>
</div>

<p>This looks better – the markers are more specific.</p>

<p>In this violin plot we do have
some instances where a marker seems to be specific to two or three cell
clusters (e.g. Lyve1).</p>

<p>In an older version of Seurat the gene Vsig4 was
also picked out. Let’s try to figure out what is going on with Vsig4:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FeaturePlot</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="s2">"Vsig4"</span><span class="p">,</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'lightgrey'</span><span class="p">,</span><span class="w"> </span><span class="s1">'red'</span><span class="p">),</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
            </span><span class="n">label.size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-vsig4-1.png" alt="plot of chunk vsig4" width="612" />
<p class="caption">plot of chunk vsig4</p>
</div>

<p>This is marking clusters c3 and a small cluster 
that may be labeled as c15
(or may be part of c11).
Vsig4 is an immune
protein (V-set and immunoglobulin domain containing 4).
The protein
<a href="https://www.proteinatlas.org/ENSG00000155659-VSIG4/tissue">is expressed</a>
selectively in – among other cell types – Kupffer cells,
which are the resident macrophages in the liver. Cluster c3 may be
Kupffer cells. Let’s check a famous macrophage marker,
F4/80 (gene name Adgre1):</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FeaturePlot</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="s2">"Adgre1"</span><span class="p">,</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'lightgrey'</span><span class="p">,</span><span class="w"> </span><span class="s1">'red'</span><span class="p">),</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
            </span><span class="n">label.size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-adgre1-1.png" alt="plot of chunk adgre1" width="612" />
<p class="caption">plot of chunk adgre1</p>
</div>

<p>Cluster c15 (if it exists)
expresses <em>Adgre1</em> but is near the hepatocyte cluster
we just discussed. In fact it is located between the hepatocyte and
Kupffer cell clusters. Cluster c15 might represent hepatocyte-Kupffer cell
doublets. Consistent with this theory, cluster c15 has intermediate expression
of Kupffer cell-specific <em>Adgre1</em> and hepatocyte-specific <em>Fabp1</em>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">VlnPlot</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Adgre1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Fabp1"</span><span class="p">),</span><span class="w"> </span><span class="n">idents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'c3'</span><span class="p">,</span><span class="w"> </span><span class="s1">'c15'</span><span class="p">,</span><span class="w"> </span><span class="s1">'c11'</span><span class="p">,</span><span class="w"> </span><span class="s1">'c1'</span><span class="p">),</span><span class="w"> 
        </span><span class="n">sort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">pt.size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-doublets-1.png" alt="plot of chunk doublets" width="576" />
<p class="caption">plot of chunk doublets</p>
</div>

<p>Let’s store our labels and look at what remains unidentified.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">labels</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tibble</span><span class="p">(</span><span class="n">cluster_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unique</span><span class="p">(</span><span class="n">liver</span><span class="o">$</span><span class="n">renamed_clusters</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
          </span><span class="n">mutate</span><span class="p">(</span><span class="n">cluster_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">cluster_num</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
          </span><span class="n">mutate</span><span class="p">(</span><span class="n">cluster_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">case_when</span><span class="p">(</span><span class="w">
                 </span><span class="n">cluster_num</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'c0'</span><span class="p">,</span><span class="w"> </span><span class="s1">'c2'</span><span class="p">,</span><span class="w"> </span><span class="s1">'c6'</span><span class="p">,</span><span class="w"> </span><span class="s1">'c12'</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s1">'ECs'</span><span class="p">,</span><span class="w">   </span><span class="c1"># endothelial cells</span><span class="w">
                 </span><span class="n">cluster_num</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'c1'</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s1">'hepatocytes'</span><span class="p">,</span><span class="w">
                 </span><span class="n">cluster_num</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'c3'</span><span class="p">,</span><span class="w"> </span><span class="s1">'c8'</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s1">'Kupffer cells'</span><span class="p">,</span><span class="w">
                 </span><span class="n">cluster_num</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'c4'</span><span class="w">  </span><span class="o">~</span><span class="w"> </span><span class="s1">'T cells'</span><span class="p">,</span><span class="w">
                 </span><span class="n">cluster_num</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'c7'</span><span class="w">  </span><span class="o">~</span><span class="w"> </span><span class="s1">'B cells'</span><span class="p">,</span><span class="w">
                 </span><span class="n">cluster_num</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'c9'</span><span class="w">  </span><span class="o">~</span><span class="w"> </span><span class="s1">'pDCs'</span><span class="p">,</span><span class="w">               </span><span class="c1"># plasmacytoid dendritic cells</span><span class="w">
                 </span><span class="n">cluster_num</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'c14'</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s1">'neutrophils'</span><span class="p">,</span><span class="w">
                 </span><span class="n">cluster_num</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'c15'</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s1">'KH doub.'</span><span class="p">,</span><span class="w">          </span><span class="c1"># Kupffer-hepatocyte doublets</span><span class="w">
                 </span><span class="kc">TRUE</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">cluster_num</span><span class="p">))</span><span class="w">

</span><span class="n">liver</span><span class="o">$</span><span class="n">labels</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deframe</span><span class="p">(</span><span class="n">labels</span><span class="p">)[</span><span class="nf">as.character</span><span class="p">(</span><span class="n">liver</span><span class="o">$</span><span class="n">renamed_clusters</span><span class="p">)],</span><span class="w">
                           </span><span class="n">row.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cells</span><span class="p">(</span><span class="n">liver</span><span class="p">))</span><span class="w">
</span><span class="n">UMAPPlot</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">label.size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="p">,</span><span class="w"> </span><span class="n">group.by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'labels'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">NoLegend</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-labelling-1.png" alt="plot of chunk labelling" width="612" />
<p class="caption">plot of chunk labelling</p>
</div>

<blockquote class="challenge">
  <h2 id="challenge-1">Challenge 1</h2>
  <p>We have identified the cell types for several large clusters. But there are
still several unlabelled clusters. We will divide the class into groups,
each of which will determine the cell type for one of the remaining clusters.
How should you do this? If you have a background in liver it
may be as simple as looking for genes you recognize as being 
involved in the tissue’s biology. More likely you are not a liver
expert. Try doing a simple Google search. You could Google 
“<em>gene</em> cell type” or “liver <em>gene</em>”. Look at the results
and see if you get any clues to the cell type.
This might include interpreting the results in light of the
biological functions of different cells in the tissue
(for example, the role of neutrophils in inflammation).
You can also ask simple questions about broad cell classifications.
For example, if it expresses CD45 (gene name Ptprc), the cell is likely
an immune cell of some kind.
You might also try going to 
https://panglaodb.se/search.html and selecting “Mouse” in the “Species”
box, then searching for genes that appear as marker genes in each cluster.</p>

  <blockquote class="solution">
    <h2 id="solution-to-challenge-1">Solution to Challenge 1</h2>

    <p>Cluster c5: Cx3cr1, Monocytes and Monocyte-derived cells<br />
Cluster c10: Dcn, Fibroblasts and/or Hepatic Stellate cells 
Cluster c11: Xcr1+ Dendritic Cells (cDC1)<br />
Cluster c13: Spp1, Cholangiocytes</p>
  </blockquote>
</blockquote>

<p>Make sure that you update the <code class="language-plaintext highlighter-rouge">liver</code> object with the cell cluster 
annotations in the solution to the challenge above.</p>

<h2 id="comparing-cell-types-to-original-paper">Comparing cell types to original paper</h2>

<p>The research group that generated this data published cell type annotation for 
each cell. We will read in this annotation an compare it with ours.</p>

<p>Read in the author’s metadata.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">metadata</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span><span class="w"> </span><span class="s1">'mouseStSt_invivo'</span><span class="p">,</span><span class="w"> </span><span class="s1">'annot_metadata.csv'</span><span class="p">),</span><span class="w">
                    </span><span class="n">show_col_types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Next, extract the cell-types from the <code class="language-plaintext highlighter-rouge">liver</code> object.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">labels</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">cell</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">liver</span><span class="o">$</span><span class="n">labels</span><span class="p">),</span><span class="w">
                     </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">liver</span><span class="o">$</span><span class="n">labels</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>And finally, join the author’s annotation with our annotation.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">annot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">left_join</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'cell'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
           </span><span class="n">dplyr</span><span class="o">::</span><span class="n">rename</span><span class="p">(</span><span class="n">our_annot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">label</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Next, we will count the number of times that each pair of cell types occurs in
the author’s annotation and our annotation.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">annot</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">dplyr</span><span class="o">::</span><span class="n">count</span><span class="p">(</span><span class="n">our_annot</span><span class="p">,</span><span class="w"> </span><span class="n">annot</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">pivot_wider</span><span class="p">(</span><span class="n">names_from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">our_annot</span><span class="p">,</span><span class="w"> </span><span class="n">values_from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">values_fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">knitr</span><span class="o">::</span><span class="n">kable</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left">annot</th>
      <th style="text-align: right">B cells</th>
      <th style="text-align: right">ECs</th>
      <th style="text-align: right">Kupffer cells</th>
      <th style="text-align: right">T cells</th>
      <th style="text-align: right">cCD1</th>
      <th style="text-align: right">cholangiocytes</th>
      <th style="text-align: right">fibroblast/stellate</th>
      <th style="text-align: right">hepatocytes</th>
      <th style="text-align: right">monocytes</th>
      <th style="text-align: right">neutrophils</th>
      <th style="text-align: right">pDCs</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">B cells</td>
      <td style="text-align: right">964</td>
      <td style="text-align: right">2</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: left">cDC2s</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">370</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: left">Basophils</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">23</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: left">Endothelial cells</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">20224</td>
      <td style="text-align: right">4</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">3</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">8</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: left">Hepatocytes</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">11</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">8570</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: left">Kupffer cells</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">53</td>
      <td style="text-align: right">8018</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">108</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">73</td>
      <td style="text-align: right">19</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: left">T cells</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">1221</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">3</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: left">cDC1s</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">14</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">400</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">2</td>
      <td style="text-align: right">8</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: left">Fibroblasts</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">96</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">735</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: left">ILC1s</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">386</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: left">Monocytes &amp; Monocyte-derived cells</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">9</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">2</td>
      <td style="text-align: right">1059</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: left">NK cells</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">214</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: left">Mig. cDCs</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">2</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">59</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: left">Cholangiocytes</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">326</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">2</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: left">HsPCs</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">2</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: left">Neutrophils</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">293</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: left">pDCs</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">951</td>
    </tr>
  </tbody>
</table>

<p>Many of the annotations that we found match what the authors found! This is
encouraging and provides a measure of reproducibility in the analysis.</p>

<h2 id="differential-expression">Differential expression</h2>

<p>Looking for differential expression can be thought of as a problem that
is related to finding cell type marker genes. Marker genes are, by definition,
genes that vary significantly between cell types. Often we are most interested
in the expression of genes that specifically mark particular cell types 
that we are interested in, but there can also be value in using broader
markers (e.g. CD45 - encoded by the gene <em>Ptprc</em> - marks all immune cells).</p>

<p>In scRNA-Seq, differential expression usually refers to differences
<em>within</em> a given cell type rather than <em>between</em> cell types.
For example, maybe we administer a drug and wish to see how gene 
expression of control group hepatocytes differs from
treatment group hepatocytes.</p>

<p>Because the liver dataset we are working with is a <em>cell atlas</em>, there is
no convenient experimental factor to use in our differential expression
comparison. Nevertheless, we will illustrate how a differential expression
test could look by making up a fake experimental factor.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">libraries</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unique</span><span class="p">(</span><span class="n">liver</span><span class="o">$</span><span class="n">sample</span><span class="p">)</span><span class="w">
</span><span class="n">treatment_group</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">setNames</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="s1">'control'</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">),</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="s1">'drug'</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">)),</span><span class="w"> </span><span class="n">libraries</span><span class="p">)</span><span class="w">
</span><span class="n">liver</span><span class="o">$</span><span class="n">trt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">grp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">treatment_group</span><span class="p">[</span><span class="n">liver</span><span class="o">$</span><span class="n">sample</span><span class="p">],</span><span class="w"> </span><span class="n">row.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cells</span><span class="p">(</span><span class="n">liver</span><span class="p">))</span><span class="w">

</span><span class="n">hepatocytes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">liver</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"hepatocytes"</span><span class="p">)</span><span class="w">
</span><span class="n">Idents</span><span class="p">(</span><span class="n">hepatocytes</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"trt"</span><span class="w">
</span><span class="n">UMAPPlot</span><span class="p">(</span><span class="n">hepatocytes</span><span class="p">,</span><span class="w"> </span><span class="n">split.by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'trt'</span><span class="p">,</span><span class="w"> </span><span class="n">group.by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'labels'</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w">
         </span><span class="n">label.size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-fake-1.png" alt="plot of chunk fake" width="720" />
<p class="caption">plot of chunk fake</p>
</div>

<p>We will look for differential expression between the 
control and drug administration groups defined
by this fake drug/control factor.
The differentially expressed genes (DEGs) can inform our understanding
of how the drug affects the biology of cells in the tissue profiled.
One quick and easy way to look for DEGs is to 
use the marker gene-finding function in Seurat, because as discussed above
the problem of differential expression is related to finding cell type 
marker genes.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">deg1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">FindMarkers</span><span class="p">(</span><span class="n">hepatocytes</span><span class="p">,</span><span class="w"> </span><span class="n">ident.1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'drug'</span><span class="p">,</span><span class="w"> </span><span class="n">ident.2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'control'</span><span class="p">,</span><span class="w">
                    </span><span class="n">logfc.threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span><span class="n">only.pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>However this approach is not ideal. It may work OK if we only have on
mouse sample from each treatment group, with thousands of cells profiled
per mouse. However, when we have multiple mice, we are failing to 
take into account
the fact that cells from a single mouse are not fully independent.
For example, if cells from one mouse are contributing the 
majority of drug-treated hepatocyte cells, and this one mouse is an outlier
that happened to have only minimal response to the drug, then we might
be fooled into thinking that the drug does not perturb hepatocytes
when in actuality the response is minimal only in 
<em>that one particular</em> mouse.</p>

<p>Let’s look at our results:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">head</span><span class="p">(</span><span class="n">deg1</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                 p_val avg_log2FC pct.1 pct.2     p_val_adj
Malat1    0.000000e+00  1.7019229 0.749 0.339  0.000000e+00
AY036118  0.000000e+00  1.8928954 0.813 0.421  0.000000e+00
Cyp3a11   0.000000e+00 -3.1288992 0.277 0.644  0.000000e+00
Rpl36al   0.000000e+00 -1.0412343 0.704 0.899  0.000000e+00
Uox       0.000000e+00 -0.8972077 0.956 0.983  0.000000e+00
Gm42418   0.000000e+00  1.7236741 0.978 0.973  0.000000e+00
Gstm1    5.705851e-293 -0.8584496 0.953 0.979 1.148017e-288
Car3     6.216806e-270 -0.7390462 0.980 0.996 1.250821e-265
Nme2     4.110392e-259 -3.7711602 0.046 0.337 8.270108e-255
C3       5.970126e-252  1.0308801 0.910 0.716 1.201189e-247
</code></pre></div></div>

<p>Wow! We have a lot of genes with apparently very strong statistically
significant differences between the control and drug administered
groups. Does this make sense? No, we just made up the control and drug
groups!
In fact, the results above are an indication of the caution that should be
applied when applying a test that does not consider biological
replicates.
What are we finding here? The second top gene, <em>Cyp3a11</em>, is 
a cytochrome P450-family gene and its transcript is higher in the 
fake control mice than the fake drug treated mice. Maybe there is some
biological meaning that could be extracted from this if we had more
detailed information on the conditions under which the fake control and
fake drug administered mouse groups were reared.</p>

<p>Nevertheless, let’s consider a more statistically robust approach
to differential expression in scRNA-Seq. 
This approach is to collapse all cells from
each biological replicate to form a “pseudobulk” sample. Then one can
use tools developed for bulk RNA-Seq samples (e.g. DESeq2 or edgeR)
to identify DEGs.
This could look like the following:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Make pseudobulks.</span><span class="w">
</span><span class="n">pseudobulk</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AggregateExpression</span><span class="p">(</span><span class="n">hepatocytes</span><span class="p">,</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'counts'</span><span class="p">,</span><span class="w"> 
                                  </span><span class="n">group.by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'sample'</span><span class="p">,</span><span class="w"> </span><span class="n">assays</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'RNA'</span><span class="p">)[[</span><span class="s1">'RNA'</span><span class="p">]]</span><span class="w">
</span><span class="nf">dim</span><span class="p">(</span><span class="n">pseudobulk</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 20120     9
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">head</span><span class="p">(</span><span class="n">pseudobulk</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>6 x 9 sparse Matrix of class "dgCMatrix"
        CS144 CS48 CS52 CS53 CS88 CS89 CS92 CS96 CS97
Xkr4        .    .    .    .    .    .    .    .    .
Rp1         .    .    .    .    .    .    .    .    .
Sox17       9    1    5    .   11    1    7   34    .
Mrpl15    812 3068 1480   11 1595  228 1367 2752  203
Lypla1    455 2161  826    3  622  162  536 1067  208
Gm37988     1    8    8    .    1    .    2    3    1
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Run DESeq2</span><span class="w">
</span><span class="n">pseudobulk_metadata</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">hepatocytes</span><span class="p">[[</span><span class="nf">c</span><span class="p">(</span><span class="s2">"sample"</span><span class="p">,</span><span class="w"> </span><span class="s2">"trt"</span><span class="p">)]]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">as_tibble</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">distinct</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">column_to_rownames</span><span class="p">(</span><span class="s1">'sample'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">trt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">trt</span><span class="p">))</span><span class="w">
</span><span class="n">pseudobulk_metadata</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pseudobulk_metadata</span><span class="p">[</span><span class="n">colnames</span><span class="p">(</span><span class="n">pseudobulk</span><span class="p">),</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">drop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">]</span><span class="w">
</span><span class="n">dds</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DESeqDataSetFromMatrix</span><span class="p">(</span><span class="n">pseudobulk</span><span class="p">,</span><span class="w"> 
                              </span><span class="n">colData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pseudobulk_metadata</span><span class="p">,</span><span class="w"> 
                              </span><span class="n">design</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">trt</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>converting counts to integer mode
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">trt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DESeq</span><span class="p">(</span><span class="n">dds</span><span class="p">,</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"LRT"</span><span class="p">,</span><span class="w"> </span><span class="n">reduced</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>estimating size factors
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>estimating dispersions
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gene-wise dispersion estimates
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mean-dispersion relationship
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>final dispersion estimates
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fitting model and testing
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">res1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">results</span><span class="p">(</span><span class="n">trt</span><span class="p">)</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">res1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>log2 fold change (MLE): trt drug vs control 
LRT p-value: '~ trt' vs '~ 1' 
DataFrame with 6 rows and 6 columns
         baseMean log2FoldChange     lfcSE      stat    pvalue      padj
        &lt;numeric&gt;      &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;
Xkr4      0.00000             NA        NA        NA        NA        NA
Rp1       0.00000             NA        NA        NA        NA        NA
Sox17     3.34090      0.9227920  1.388072 0.6858481  0.407580         1
Mrpl15  616.31410      0.0341665  0.224516 0.0979955  0.754248         1
Lypla1  329.82425     -0.0449272  0.260602 0.2829471  0.594776         1
Gm37988   1.17336     -0.8612866  1.783219 0.0289742  0.864839         1
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">sum</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">res1</span><span class="o">$</span><span class="n">padj</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">res1</span><span class="o">$</span><span class="n">padj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 0
</code></pre></div></div>

<p>No genes are significantly differentially expressed using this 
pseudobulk + DESeq2 approach.</p>

<h2 id="pathway-enrichment">Pathway enrichment</h2>

<p>We may wish to look for enrichment of biological pathways 
in a list of genes. Here we will show one example of completing this 
task. There are many ways to do enrichment tests, and they are
typically not conducted in a way that is unique to single cell data
thus you have a wide range of options.</p>

<p>Here we will test for enrichment of biological function using our
neutrophil markers (our original cluster c14). 
We could do this with any cell type but we
pick neutrophils in the hope that they give a clear and interpretable
answer. We will query three databases: KEGG, Gene Ontology biological 
process, and MSigDB Hallmark pathways:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">db_names</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"KEGG"</span><span class="o">=</span><span class="s1">'KEGG_2019_Mouse'</span><span class="p">,</span><span class="w">
              </span><span class="s2">"GO"</span><span class="o">=</span><span class="s1">'GO_Biological_Process_2021'</span><span class="p">,</span><span class="w">
              </span><span class="s2">"MsigDB"</span><span class="o">=</span><span class="s1">'MSigDB_Hallmark_2020'</span><span class="p">)</span><span class="w">
</span><span class="n">genes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">markers</span><span class="p">,</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'c14'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">top_n</span><span class="p">(</span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="n">avg_log2FC</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">pull</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span><span class="w">
</span><span class="n">enrich_genes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichr</span><span class="p">(</span><span class="n">genes</span><span class="p">,</span><span class="w"> </span><span class="n">databases</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">db_names</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Uploading data to Enrichr... Done.
  Querying KEGG_2019_Mouse... Done.
  Querying GO_Biological_Process_2021... Done.
  Querying MSigDB_Hallmark_2020... Done.
Parsing results... Done.
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">names</span><span class="p">(</span><span class="n">enrich_genes</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">db_names</span><span class="p">)</span><span class="w">
</span><span class="n">e</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">bind_rows</span><span class="p">(</span><span class="n">enrich_genes</span><span class="p">,</span><span class="w"> </span><span class="n">.id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'database'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">Term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="w"> </span><span class="s1">': '</span><span class="p">,</span><span class="w"> </span><span class="n">Term</span><span class="p">))</span><span class="w">
</span><span class="n">plotEnrich</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Neutrophil pathway enrichment"</span><span class="p">,</span><span class="w"> 
           </span><span class="n">showTerms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="n">numChar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="figure" style="text-align: center">
<img src="../fig/rmd-06-pway-1.png" alt="plot of chunk pway" width="648" />
<p class="caption">plot of chunk pway</p>
</div>

<p>OK, these results look appropriate for neutrophil biological function!</p>

<h3 id="session-info">Session Info</h3>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sessionInfo</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>R version 4.4.1 (2024-06-14)
Platform: x86_64-apple-darwin20
Running under: macOS 15.0.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.4-x86_64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.4-x86_64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/New_York
tzcode source: internal

attached base packages:
[1] stats4    stats     graphics  grDevices utils     datasets  methods  
[8] base     

other attached packages:
 [1] enrichR_3.2                 DESeq2_1.44.0              
 [3] SummarizedExperiment_1.34.0 Biobase_2.64.0             
 [5] MatrixGenerics_1.16.0       matrixStats_1.4.1          
 [7] GenomicRanges_1.56.2        GenomeInfoDb_1.40.1        
 [9] IRanges_2.38.1              S4Vectors_0.42.1           
[11] BiocGenerics_0.50.0         harmony_1.2.1              
[13] Rcpp_1.0.13                 Seurat_5.1.0               
[15] SeuratObject_5.0.2          sp_2.1-4                   
[17] lubridate_1.9.3             forcats_1.0.0              
[19] stringr_1.5.1               dplyr_1.1.4                
[21] purrr_1.0.2                 readr_2.1.5                
[23] tidyr_1.3.1                 tibble_3.2.1               
[25] ggplot2_3.5.1               tidyverse_2.0.0            
[27] knitr_1.48                 

loaded via a namespace (and not attached):
  [1] RColorBrewer_1.1-3      jsonlite_1.8.9          magrittr_2.0.3         
  [4] ggbeeswarm_0.7.2        spatstat.utils_3.1-0    farver_2.1.2           
  [7] zlibbioc_1.50.0         vctrs_0.6.5             ROCR_1.0-11            
 [10] spatstat.explore_3.3-2  S4Arrays_1.4.1          htmltools_0.5.8.1      
 [13] curl_5.2.3              SparseArray_1.4.8       sctransform_0.4.1      
 [16] parallelly_1.38.0       KernSmooth_2.23-24      htmlwidgets_1.6.4      
 [19] ica_1.0-3               plyr_1.8.9              plotly_4.10.4          
 [22] zoo_1.8-12              igraph_2.0.3            mime_0.12              
 [25] lifecycle_1.0.4         pkgconfig_2.0.3         Matrix_1.7-0           
 [28] R6_2.5.1                fastmap_1.2.0           GenomeInfoDbData_1.2.12
 [31] fitdistrplus_1.2-1      future_1.34.0           shiny_1.9.1            
 [34] digest_0.6.37           colorspace_2.1-1        patchwork_1.3.0        
 [37] tensor_1.5              RSpectra_0.16-2         irlba_2.3.5.1          
 [40] labeling_0.4.3          WriteXLS_6.7.0          progressr_0.14.0       
 [43] fansi_1.0.6             spatstat.sparse_3.1-0   timechange_0.3.0       
 [46] httr_1.4.7              polyclip_1.10-7         abind_1.4-8            
 [49] compiler_4.4.1          bit64_4.5.2             withr_3.0.1            
 [52] BiocParallel_1.38.0     fastDummies_1.7.4       highr_0.11             
 [55] MASS_7.3-60.2           DelayedArray_0.30.1     rjson_0.2.23           
 [58] tools_4.4.1             vipor_0.4.7             lmtest_0.9-40          
 [61] beeswarm_0.4.0          httpuv_1.6.15           future.apply_1.11.2    
 [64] goftest_1.2-3           glue_1.8.0              nlme_3.1-164           
 [67] promises_1.3.0          grid_4.4.1              Rtsne_0.17             
 [70] cluster_2.1.6           reshape2_1.4.4          generics_0.1.3         
 [73] gtable_0.3.5            spatstat.data_3.1-2     tzdb_0.4.0             
 [76] data.table_1.16.2       hms_1.1.3               utf8_1.2.4             
 [79] XVector_0.44.0          spatstat.geom_3.3-3     RcppAnnoy_0.0.22       
 [82] ggrepel_0.9.6           RANN_2.6.2              pillar_1.9.0           
 [85] vroom_1.6.5             spam_2.11-0             RcppHNSW_0.6.0         
 [88] later_1.3.2             splines_4.4.1           lattice_0.22-6         
 [91] bit_4.5.0               survival_3.6-4          deldir_2.0-4           
 [94] tidyselect_1.2.1        locfit_1.5-9.10         miniUI_0.1.1.1         
 [97] pbapply_1.7-2           gridExtra_2.3           scattermore_1.2        
[100] RhpcBLASctl_0.23-42     xfun_0.48               stringi_1.8.4          
[103] UCSC.utils_1.0.0        lazyeval_0.2.2          evaluate_1.0.1         
[106] codetools_0.2-20        cli_3.6.3               uwot_0.2.2             
[109] xtable_1.8-4            reticulate_1.39.0       munsell_0.5.1          
[112] globals_0.16.3          spatstat.random_3.3-2   png_0.1-8              
[115] ggrastr_1.0.2           spatstat.univar_3.0-1   parallel_4.4.1         
[118] presto_1.0.0            dotCall64_1.2           listenv_0.9.1          
[121] viridisLite_0.4.2       scales_1.3.0            ggridges_0.5.6         
[124] crayon_1.5.3            leiden_0.4.3.1          rlang_1.1.4            
[127] cowplot_1.1.3          
</code></pre></div></div>





<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>Identifying cell types is a major objective in scRNA-Seq and can be present challenges that are unique to each dataset.</p>
</li>
    
    <li><p>Statistically minded experimental design enables you to perform differential gene expression analyses that are likely to result in meaningful biological results.</p>
</li>
    
  </ul>
</blockquote>

</article>


















  
  











<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../05-Common-Analyses/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../07-Analyzing-Your-Data/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>


      
      






<footer>
  <div class="row">
    <div class="col-md-6 license" id="license-info" align="left">
	
	Licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0</a> 2018–2024
	by <a href="https://carpentries.org/">The Carpentries</a>
        <br>
        Licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0</a> 2016–2018
	by <a href="https://software-carpentry.org">Software Carpentry Foundation</a>
	
    </div>
    <div class="col-md-6 help-links" align="right">
	
	
	<a href="/edit//_episodes_rmd/06-Biology-Driven-Analyses.Rmd" data-checker-ignore>Edit on GitHub</a>
	
	
	/
	<a href="/blob//CONTRIBUTING.md" data-checker-ignore>Contributing</a>
	/
	<a href="/">Source</a>
	/
	<a href="/blob//CITATION" data-checker-ignore>Cite</a>
	/
	<a href="mailto:team@carpentries.org">Contact</a>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12" align="center">
      Using <a href="https://github.com/carpentries/styles/">The Carpentries style</a>
      version <a href="https://github.com/carpentries/styles/releases/tag/v9.5.3">9.5.3</a>.
    </div>
  </div>
</footer>

      
    </div>
    
<script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/lesson.js"></script>


<!-- Matomo -->
<script>
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
  _paq.push(["setDomains", ["*.lessons.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io"]]);
  _paq.push(["setDoNotTrack", true]);
  _paq.push(["disableCookies"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="https://carpentries.matomo.cloud/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src='//cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->


<script src="../assets/js/anchor.min.js"></script>
<script>
    anchors.add();
</script>

  </body>
</html>
